<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>Трекер РД — проекты (онлайн)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <div class="brand">Трекер РД</div>
      <select id="projectSelect" title="Проект"></select>
      <button id="addProject" class="ghost">+ Проект</button>
      <span id="userInfo" class="badge">…</span>
    </div>
    <div class="right">
      <button id="btnAddRow">+ Строка</button>
      <button id="btnSaveAll" class="secondary">Сохранить всё</button>
      <button id="btnAddExec" class="secondary">+ Исполнитель</button>
      <button id="btnHistory" class="secondary">История</button>
      <button id="btnExportCSV" class="secondary">Экспорт CSV</button>
      <button id="btnPrint">Печать / PDF</button>
    </div>
  </div>

  <div class="container">
    <div class="kpis">
      <div class="card kpi"><div class="title">Всего</div><div class="num" id="kAll">—</div></div>
      <div class="card kpi"><div class="title">✅ Готово</div><div class="num" id="kDone">—</div></div>
      <div class="card kpi"><div class="title">⚙️ В работе</div><div class="num" id="kInProgress">—</div></div>
      <div class="card kpi"><div class="title">⏳ Не начато</div><div class="num" id="kTodo">—</div></div>
      <div class="card kpi"><div class="title">Новые листы</div><div class="num" id="kNew">—</div></div>
      <div class="card kpi">
        <div class="title">Прогресс</div>
        <div class="progress"><progress id="progressBar" value="0" max="100"></progress><span id="progressPct">0%</span></div>
      </div>
    </div>

    <div class="card controls">
      <label>Статус:
        <select id="filterStatus">
          <option value="">Все</option>
          <option>✅ Готово</option>
          <option>⚙️ В работе</option>
          <option>⏳ Не начато</option>
        </select>
      </label>
      <label>Исполнитель:
        <select id="filterExecutor">
          <option value="">Все</option>
        </select>
      </label>
      <label><input type="checkbox" id="filterNew"/> Только новые</label>
    </div>

    <div class="table-wrap card">
      <table id="rdTable">
        <thead>
          <tr>
            <th style="width:60px;">№</th>
            <th style="min-width:360px;">Наименование листа</th>
            <th style="min-width:320px;">Изменения / Примечания</th>
            <th style="width:100px;">Новый лист</th>
            <th style="width:160px;">Статус</th>
            <th style="width:220px;">Исполнитель</th>
            <th style="width:150px;">Дата сдачи</th>
            <th style="min-width:260px;">Комментарии</th>
            <th style="min-width:220px;">Ссылка на файл</th>
            <th style="width:120px;">Действия</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="historyModal" class="modal">
    <div class="box">
      <header>
        <strong>История изменений</strong>
        <button id="historyClose" class="ghost">Закрыть</button>
      </header>
      <div class="content" id="historyList">Загрузка…</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCVCy0pdqRTrxsPzs_7bcelelCjMpcGli8",
      authDomain: "rd-tracker-f1921.firebaseapp.com",
      projectId: "rd-tracker-f1921",
      storageBucket: "rd-tracker-f1921.firebasestorage.app",
      messagingSenderId: "633046340169",
      appId: "1:633046340169:web:e2d3d54f43af132d5c6598",
      measurementId: "G-6ZT47WT1EM"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    window._auth = getAuth(app);
    window._db   = getFirestore(app);

    signInAnonymously(window._auth).catch(console.error);
    onAuthStateChanged(window._auth, user => {
      const el = document.getElementById('userInfo');
      if (user) { el.textContent = "UID: " + user.uid.slice(0,6) + "…"; window._readyFirebase?.(); }
      else { el.textContent = "Не авторизован"; }
    });
  </script>
  <script src="app.js"></script>
</body>
</html>
